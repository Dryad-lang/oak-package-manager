services:
  # Laravel Frontend
  dryad-web:
    build: 
      context: ./dryad-web
      dockerfile: Dockerfile
    container_name: dryad-web
    ports:
      - "7800:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DRYAD_REGISTRY_URL=http://registry-api:4000
    # volumes:
    #   - ./dryad-web:/var/www/html  # Removido para n√£o sobrescrever vendor/
    depends_on:
      - registry-api
      - postgres
    networks:
      - dryad-network

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: dryad-postgres
    ports:
      - "7832:5432"
    environment:
      - POSTGRES_DB=dryad_packages
      - POSTGRES_USER=dryad_user
      - POSTGRES_PASSWORD=dryad_pass
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - dryad-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dryad_user -d dryad_packages"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Registry API Server
  registry-api:
    build: 
      context: ./registry-server/registry-api
      dockerfile: Dockerfile
    container_name: dryad-registry-api
    ports:
      - "7840:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - PACKAGES_DIR=/app/packages
      - UPLOADS_DIR=/app/uploads
      - GITEA_URL=http://gitea:3000
      - GITEA_TOKEN=gitea_admin_token
      - GITEA_USERNAME=admin
      - GITEA_PASSWORD=admin123
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=dryad_packages
      - POSTGRES_USER=dryad_user
      - POSTGRES_PASSWORD=dryad_pass
    volumes:
      - registry-packages:/app/packages
      - registry-uploads:/app/uploads
      - ./registry:/app/registry:ro
    networks:
      - dryad-network
    depends_on:
      - postgres
      - gitea
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Git Server (Gitea) para versionamento de pacotes
  gitea:
    image: gitea/gitea:1.21
    container_name: dryad-gitea
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=postgres:5432
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea_password
      - GITEA__server__DOMAIN=localhost
      - GITEA__server__SSH_DOMAIN=localhost
      - GITEA__server__ROOT_URL=http://localhost:7850/
      - GITEA__server__HTTP_PORT=3000
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__security__SECRET_KEY=dryad_gitea_secret_key_2024
      - GITEA__webhook__ALLOWED_HOST_LIST=*
      - GITEA__service__DISABLE_REGISTRATION=false
      - GITEA__service__REQUIRE_SIGNIN_VIEW=false
    restart: unless-stopped
    networks:
      - dryad-network
    volumes:
      - gitea-data:/data
    ports:
      - "7850:3000"
      - "7822:22"
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: dryad-nginx
    ports:
      - "7880:80"
      - "7843:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - dryad-web
      - registry-api
    networks:
      - dryad-network

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    container_name: dryad-redis
    ports:
      - "7879:6379"
    volumes:
      - redis-data:/data
    networks:
      - dryad-network

networks:
  dryad-network:
    driver: bridge

volumes:
  registry-packages:
    driver: local
  registry-uploads:
    driver: local
  redis-data:
    driver: local
  postgres-data:
    driver: local
  gitea-data:
    driver: local