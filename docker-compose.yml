version: '3.8'

services:
  # Laravel Frontend
  dryad-web:
    build: 
      context: ./dryad-web
      dockerfile: Dockerfile
    container_name: dryad-web
    ports:
      - "7800:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DRYAD_REGISTRY_URL=http://registry-api:4000
    # volumes:
    #   - ./dryad-web:/var/www/html  # Removido para n√£o sobrescrever vendor/
    depends_on:
      - registry-api
      - postgres
    networks:
      - dryad-network

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: dryad-postgres
    ports:
      - "7832:5432"
    environment:
      - POSTGRES_DB=dryad_packages
      - POSTGRES_USER=dryad_user
      - POSTGRES_PASSWORD=dryad_pass
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - dryad-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dryad_user -d dryad_packages"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Registry API Server
  registry-api:
    build: 
      context: ./registry-server/registry-api
      dockerfile: Dockerfile
    container_name: dryad-registry-api
    ports:
      - "7840:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - PACKAGES_DIR=/app/packages
      - UPLOADS_DIR=/app/uploads
    volumes:
      - registry-packages:/app/packages
      - registry-uploads:/app/uploads
      - ./registry:/app/registry:ro
    networks:
      - dryad-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: dryad-nginx
    ports:
      - "7880:80"
      - "7843:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - dryad-web
      - registry-api
    networks:
      - dryad-network

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    container_name: dryad-redis
    ports:
      - "7879:6379"
    volumes:
      - redis-data:/data
    networks:
      - dryad-network

networks:
  dryad-network:
    driver: bridge

volumes:
  registry-packages:
    driver: local
  registry-uploads:
    driver: local
  redis-data:
    driver: local
  postgres-data:
    driver: local