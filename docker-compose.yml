services:
  # Laravel Frontend & Registry API
  laravel:
    build:
      context: ./dryad-web
      dockerfile: Dockerfile
    ports:
      - "7800:8000"
    volumes:
      - ./dryad-web:/var/www/html
      - laravel_storage:/var/www/html/storage
    environment:
      - DB_CONNECTION=mysql
      - DB_HOST=mariadb
      - DB_PORT=3306
      - DB_DATABASE=dryad
      - DB_USERNAME=dryad
      - DB_PASSWORD=dryad_pass
      - FORGEJO_URL=http://forgejo:3000
      - FORGEJO_TOKEN=${FORGEJO_TOKEN:-}
      - APP_URL=http://localhost:8000
      - APP_ENV=local
      - APP_DEBUG=true
    depends_on:
      - mariadb
      - forgejo
    networks:
      - oak_network

  # MariaDB Database
  mariadb:
    image: mariadb:11
    environment:
      - MYSQL_ROOT_PASSWORD=root_pass
      - MYSQL_DATABASE=dryad
      - MYSQL_USER=dryad
      - MYSQL_PASSWORD=dryad_pass
    volumes:
      - mariadb_data:/var/lib/mysql
    ports:
      - "7832:3306"
    networks:
      - oak_network

  # Forgejo Git Server
  forgejo:
    image: data.forgejo.org/forgejo/forgejo:13
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=sqlite3
      - FORGEJO__database__PATH=/data/forgejo.db
      - FORGEJO__server__DOMAIN=localhost
      - FORGEJO__server__HTTP_PORT=3000
      - FORGEJO__server__ROOT_URL=http://localhost:7850/
      - FORGEJO__server__SSH_PORT=22
      - FORGEJO__server__START_SSH_SERVER=true
      - FORGEJO__service__DISABLE_REGISTRATION=false
      - FORGEJO__service__REQUIRE_SIGNIN_VIEW=false
      - FORGEJO__actions__ENABLED=false
    volumes:
      - forgejo_data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "7850:3000"
      - "7822:22"
    networks:
      - oak_network

volumes:
  mariadb_data:
  forgejo_data:
  laravel_storage:

networks:
  oak_network:
    driver: bridge